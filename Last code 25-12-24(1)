#include <WiFi.h>
#include<time.h>
#include <FS.h>
#include <WebServer.h>
#include <Wire.h>                    
#include <LiquidCrystal_I2C.h> 
#include <Preferences.h>
#include <Adafruit_Fingerprint.h>
#include <SoftwareSerial.h>
#include <SPIFFS.h>
#include <Keypad.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>

#define MAX_STUDENTS 100  // Adjust this based on the maximum number of students

bool attendedStudents[MAX_STUDENTS] = {false};  // Array to track attendance
bool isAttendanceMode = false;

LiquidCrystal_I2C lcd(0x27, 16, 2);  // 16 columns, 2 rows, address is typically 0x27
Preferences preferences;
// Define keypad size (rows and columns)
const byte ROWS = 4; // Four rows
const byte COLS = 4; // Four columns

// Key mapping
char keys[ROWS][COLS] = {
  {'1', '2', '3', 'A'},
  {'4', '5', '6', 'B'},
  {'7', '8', '9', 'C'},
  {'*', '0', '#', 'D'}
};

// Connect keypad rows and columns to GPIO pins on the ESP32S
byte rowPins[ROWS] = {18, 19, 25, 26}; // Adjust as per your wiring
byte colPins[COLS] = {23, 5, 4, 15};   // Adjust as per your wiring

// Create a Keypad object
Keypad keypad = Keypad(makeKeymap(keys), rowPins, colPins, ROWS, COLS);


#define RX_PIN 16
#define TX_PIN 17

SoftwareSerial mySerial(RX_PIN, TX_PIN);
Adafruit_Fingerprint finger(&mySerial);
WebServer server(80);


String ssid = "";
String password = "";
String coursecode = "";

const char* adminUsername = "admin";
const char* adminPassword = "admin123";
const char* teacherDataFile = "/teachers.csv";
const char* studentDataFile = "/students.csv";
const char* SUPABASE_URL = "YOUR_SUPABASE_URL";
const char* SUPABASE_KEY = "YOUR_SUPABASE_ANON_KEY";
void handleEditTeacher();
void handleEditStudent();
void handleEditAttendance();
void handleUpdateTeacher();
void handleUpdateStudent();
void handleDeleteTeacher();
void handleDeleteStudent();
void handleDeleteAttendanceRecord();
void handleEditTeacher() {
  if (!authenticateUser()) {
    return;
  }

  String htmlPage = R"rawliteral(
    <!DOCTYPE html>
    <html>
    <head>
        <style>
            table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 20px;
            }
            th, td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: left;
            }
            th {
                background-color: #4CAF50;
                color: white;
            }
            .edit-btn {
                background-color: #4CAF50;
                color: white;
                padding: 5px 10px;
                border: none;
                cursor: pointer;
            }
            .delete-btn {
                background-color: #f44336;
                color: white;
                padding: 5px 10px;
                border: none;
                cursor: pointer;
            }
        </style>
    </head>
    <body>
        <h2>Edit Teachers</h2>
        <table>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Course Code</th>
                <th>Actions</th>
            </tr>
    )rawliteral";

  File file = SPIFFS.open(teacherDataFile, "r");
  while (file.available()) {
    String line = file.readStringUntil('\n');
    line.trim();
    if (line.length() > 0) {
      int firstComma = line.indexOf(',');
      int lastComma = line.lastIndexOf(',');
      String id = line.substring(0, firstComma);
      String name = line.substring(firstComma + 1, lastComma);
      String courseCode = line.substring(lastComma + 1);

      htmlPage += "<tr><td>" + id + "</td><td>" + name + "</td><td>" + courseCode + 
                 "</td><td><button class='edit-btn' onclick='editTeacher(\"" + id + "\", \"" + name + "\", \"" + courseCode + 
                 "\")'>Edit</button> <button class='delete-btn' onclick='deleteTeacher(\"" + id + 
                 "\")'>Delete</button></td></tr>";
    }
  }
  file.close();

  htmlPage += R"rawliteral(
        </table>
        <script>
            function editTeacher(id, name, courseCode) {
                let newName = prompt("Enter new name:", name);
                let newCourseCode = prompt("Enter new course code:", courseCode);
                if (newName && newCourseCode) {
                    window.location.href = `/updateTeacher?id=${id}&name=${newName}&courseCode=${newCourseCode}`;
                }
            }
            function deleteTeacher(id) {
                if (confirm("Are you sure you want to delete this teacher?")) {
                    window.location.href = `/deleteTeacher?id=${id}`;
                }
            }
        </script>
    </body>
    </html>
  )rawliteral";

  server.send(200, "text/html", htmlPage);
}

void handleUpdateTeacher() {
  if (!authenticateUser()) {
    return;
  }

  String id = server.arg("id");
  String newName = server.arg("name");
  String newCourseCode = server.arg("courseCode");

  File oldFile = SPIFFS.open(teacherDataFile, "r");
  File newFile = SPIFFS.open("/temp.csv", "w");

  while (oldFile.available()) {
    String line = oldFile.readStringUntil('\n');
    if (line.startsWith(id + ",")) {
      newFile.println(id + "," + newName + "," + newCourseCode);
    } else {
      newFile.println(line);
    }
  }

  oldFile.close();
  newFile.close();

  SPIFFS.remove(teacherDataFile);
  SPIFFS.rename("/temp.csv", teacherDataFile);

  server.sendHeader("Location", "/editTeacher");
  server.send(303);
}

void handleDeleteTeacher() {
  if (!authenticateUser()) {
    return;
  }

  String id = server.arg("id");
  File oldFile = SPIFFS.open(teacherDataFile, "r");
  File newFile = SPIFFS.open("/temp.csv", "w");

  while (oldFile.available()) {
    String line = oldFile.readStringUntil('\n');
    if (!line.startsWith(id + ",")) {
      newFile.println(line);
    }
  }

  oldFile.close();
  newFile.close();

  SPIFFS.remove(teacherDataFile);
  SPIFFS.rename("/temp.csv", teacherDataFile);

  server.sendHeader("Location", "/editTeacher");
  server.send(303);
}

// Similar functions for students
void handleEditStudent() {
  if (!authenticateUser()) {
    return;
  }

  String htmlPage = R"rawliteral(
    <!DOCTYPE html>
    <html>
    <head>
        <style>
            table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 20px;
            }
            th, td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: left;
            }
            th {
                background-color: #4CAF50;
                color: white;
            }
            .edit-btn {
                background-color: #4CAF50;
                color: white;
                padding: 5px 10px;
                border: none;
                cursor: pointer;
            }
            .delete-btn {
                background-color: #f44336;
                color: white;
                padding: 5px 10px;
                border: none;
                cursor: pointer;
            }
        </style>
    </head>
    <body>
        <h2>Edit Students</h2>
        <table>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Roll Number</th>
                <th>Actions</th>
            </tr>
    )rawliteral";

  File file = SPIFFS.open(studentDataFile, "r");
  while (file.available()) {
    String line = file.readStringUntil('\n');
    line.trim();
    if (line.length() > 0) {
      int firstComma = line.indexOf(',');
      int lastComma = line.lastIndexOf(',');
      String id = line.substring(0, firstComma);
      String name = line.substring(firstComma + 1, lastComma);
      String rollNumber = line.substring(lastComma + 1);

      htmlPage += "<tr><td>" + id + "</td><td>" + name + "</td><td>" + rollNumber + 
                 "</td><td><button class='edit-btn' onclick='editStudent(\"" + id + "\", \"" + name + "\", \"" + rollNumber + 
                 "\")'>Edit</button> <button class='delete-btn' onclick='deleteStudent(\"" + id + 
                 "\")'>Delete</button></td></tr>";
    }
  }
  file.close();

  htmlPage += R"rawliteral(
        </table>
        <script>
            function editStudent(id, name, rollNumber) {
                let newName = prompt("Enter new name:", name);
                let newRollNumber = prompt("Enter new roll number:", rollNumber);
                if (newName && newRollNumber) {
                    window.location.href = `/updateStudent?id=${id}&name=${newName}&rollNumber=${newRollNumber}`;
                }
            }
            function deleteStudent(id) {
                if (confirm("Are you sure you want to delete this student?")) {
                    window.location.href = `/deleteStudent?id=${id}`;
                }
            }
        </script>
    </body>
    </html>
  )rawliteral";

  server.send(200, "text/html", htmlPage);
}

void handleUpdateStudent() {
  if (!authenticateUser()) {
    return;
  }

  String id = server.arg("id");
  String newName = server.arg("name");
  String newRollNumber = server.arg("rollNumber");

  File oldFile = SPIFFS.open(studentDataFile, "r");
  File newFile = SPIFFS.open("/temp.csv", "w");

  while (oldFile.available()) {
    String line = oldFile.readStringUntil('\n');
    if (line.startsWith(id + ",")) {
      newFile.println(id + "," + newName + "," + newRollNumber);
    } else {
      newFile.println(line);
    }
  }

  oldFile.close();
  newFile.close();

  SPIFFS.remove(studentDataFile);
  SPIFFS.rename("/temp.csv", studentDataFile);

  server.sendHeader("Location", "/editStudent");
  server.send(303);
}

void handleDeleteStudent() {
  if (!authenticateUser()) {
    return;
  }

  String id = server.arg("id");
  File oldFile = SPIFFS.open(studentDataFile, "r");
  File newFile = SPIFFS.open("/temp.csv", "w");

  while (oldFile.available()) {
    String line = oldFile.readStringUntil('\n');
    if (!line.startsWith(id + ",")) {
      newFile.println(line);
    }
  }

  oldFile.close();
  newFile.close();

  SPIFFS.remove(studentDataFile);
  SPIFFS.rename("/temp.csv", studentDataFile);

  server.sendHeader("Location", "/editStudent");
  server.send(303);
}

void handleEditAttendance() {
  if (!authenticateUser()) {
    return;
  }

  String htmlPage = R"rawliteral(
    <!DOCTYPE html>
    <html>
    <head>
        <style>
            table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 20px;
            }
            th, td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: left;
            }
            th {
                background-color: #4CAF50;
                color: white;
            }
            .delete-btn {
                background-color: #f44336;
                color: white;
                padding: 5px 10px;
                border: none;
                cursor: pointer;
            }
        </style>
    </head>
    <body>
        <h2>Edit Attendance Records</h2>
        <table>
            <tr>
                <th>Course Code</th>
                <th>Student Name</th>
                <th>Student ID</th>
                <th>Timestamp</th>
                <th>Actions</th>
            </tr>
    )rawliteral";

  File file = SPIFFS.open("/attendance.csv", "r");
  while (file.available()) {
    String line = file.readStringUntil('\n');
    line.trim();
    if (line.length() > 0) {
      // Parse CSV line and create table row with delete button
      int comma1 = line.indexOf(',');
      int comma2 = line.indexOf(',', comma1 + 1);
      int comma3 = line.indexOf(',', comma2 + 1);
      
      String courseCode = line.substring(0, comma1);
      String studentName = line.substring(comma1 + 1, comma2);
      String studentId = line.substring(comma2 + 1, comma3);
      String timestamp = line.substring(comma3 + 1);

      htmlPage += "<tr><td>" + courseCode + "</td><td>" + studentName + "</td><td>" + 
                 studentId + "</td><td>" + timestamp + "</td><td>" +
                 "<button class='delete-btn' onclick='deleteRecord(\"" + courseCode + "\",\"" + 
                 studentId + "\",\"" + timestamp + "\")'>Delete</button></td></tr>";
    }
  }
  file.close();

  htmlPage += R"rawliteral(
        </table>
        <script>
            function deleteRecord(courseCode, studentId, timestamp) {
                if (confirm("Are you sure you want to delete this attendance record?")) {
                    window.location.href = `/deleteAttendanceRecord?courseCode=${courseCode}&studentId=${studentId}&timestamp=${timestamp}`;
                }
            }
        </script>
    </body>
    </html>
  )rawliteral";

  server.send(200, "text/html", htmlPage);
}

void handleDeleteAttendanceRecord() {
  if (!authenticateUser()) {
    return;
  }

  String courseCode = server.arg("courseCode");
  String studentId = server.arg("studentId");
  String timestamp = server.arg("timestamp");

  File oldFile = SPIFFS.open("/attendance.csv", "r");
  File newFile = SPIFFS.open("/temp.csv", "w");

  while (oldFile.available()) {
    String line = oldFile.readStringUntil('\n');
    if (!line.startsWith(courseCode + "," + studentId + "," + timestamp)) {
      newFile.println(line);
    }
  }

  oldFile.close();
  newFile.close();

  SPIFFS.remove("/attendance.csv");
  SPIFFS.rename("/temp.csv", "/attendance.csv");

  server.sendHeader("Location", "/editAttendance");
  server.send(303);
}
bool initializeFingerprint() {
    mySerial.begin(57600);
    delay(100);
    finger.begin(57600);
    delay(100);
    
    int retry = 0;
    while (!finger.verifyPassword()) {
        if (retry >= 3) {
            Serial.println("Fingerprint sensor not detected or communication error!");
            lcd.clear();
            lcd.setCursor(0, 0);
            lcd.print("Sensor Error!");
            lcd.setCursor(0, 1);
            lcd.print("Check Connection");
            return false;
        }
        Serial.println("Retrying sensor connection...");
        delay(1000);
        retry++;
    }
    
    Serial.println("Fingerprint sensor initialized successfully!");
    return true;
}

bool sendToSupabase(const char* table, const String& jsonData) {
  HTTPClient http;
  String url = String(SUPABASE_URL) + "/rest/v1/" + table;
  
  http.begin(url);
  http.addHeader("apikey", SUPABASE_KEY);
  http.addHeader("Authorization", "Bearer " + String(SUPABASE_KEY));
  http.addHeader("Content-Type", "application/json");
  http.addHeader("Prefer", "return=minimal");
  
  int httpCode = http.POST(jsonData);
  bool success = (httpCode == 201);
  http.end();
  
  return success;
}

// Connect to Wi-Fi
bool connectToWiFi(const char* ssid, const char* password) {
  WiFi.mode(WIFI_STA);
  WiFi.begin(ssid, password);
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("Connecting...");
  Serial.print("Connecting to Wi-Fi");

  int timeout = 0;
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
    timeout++;
    if (timeout > 20) {
      Serial.println("\nFailed to connect to Wi-Fi");
      lcd.clear();
      lcd.setCursor(0, 0);
      lcd.print("Wi-Fi Failed");
      delay(2000);
      return false;
    }
  }

  Serial.println("\nConnected to Wi-Fi!");
  Serial.print("IP Address: ");
  Serial.println(WiFi.localIP());
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("Connected");
  lcd.setCursor(0, 1);
  lcd.print(WiFi.localIP().toString());

  return true;
}

// Start Wi-Fi in AP mode
void startAccessPoint() {
  WiFi.mode(WIFI_AP);
  WiFi.softAP("ESP32_Config", "123456789");
  Serial.println("Access Point Started");
  Serial.print("AP IP Address: ");
  Serial.println(WiFi.softAPIP());
}

// Authenticate User
bool authenticateUser() {
  if (!server.authenticate(adminUsername, adminPassword)) {
    server.requestAuthentication();
    return false;
  }
  return true;
}

// Serve the root page after login
void handleRoot() {
  if (!authenticateUser()) {
    return;
  }

  String wifiStatus = "Not connected";
  if (WiFi.status() == WL_CONNECTED) {
    wifiStatus = WiFi.SSID();
  }

  String htmlPage = R"rawliteral(
    <!DOCTYPE html>
    <html>
     <body>
     
    <div class="dashboard-container">
        <h2 class="dashboard-title">Admin Dashboard</h2>
        <p class="wifi-status">Current Wi-Fi Status: )rawliteral" + wifiStatus + R"rawliteral(</p>
        
        <div class="menu-container">
            <a href="/wifi" class="menu-button" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                <i class="icon">üì°</i>Change Wi-Fi Settings
            </a>
            
            <a href="/enrollTeacher" class="menu-button" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                <i class="icon">üë®‚Äçüè´</i>Teacher Enrollment
            </a>
            
            <a href="/downloadTeachers" class="menu-button" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                <i class="icon">üì•</i>Download Teacher Data
            </a>
            
            <a href="/downloadStudents" class="menu-button" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                <i class="icon">üìö</i>Download Student Data
            </a>
            
            <a href="/enrollStudent" class="menu-button" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                <i class="icon">üë®‚Äçüéì</i>Student Enrollment
            </a>
            
            <a href="/attendencemode" class="menu-button" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                <i class="icon">‚úÖ</i>Attendance Mode
            </a>
            
            <a href="/downloadAttendance" class="menu-button" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                <i class="icon">üìä</i>View Attendance
            </a>
            <a href="/editTeacher" class="menu-button" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
    <i class="icon">‚úèÔ∏è</i>Edit Teachers
    </a>

    <a href="/editStudent" class="menu-button" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
    <i class="icon">‚úèÔ∏è</i>Edit Students
     </a>

    <a href="/editAttendance" class="menu-button" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
    <i class="icon">‚úèÔ∏è</i>Edit Attendance
    </a>
        </div>
        
        <a href="/deleteAllFiles" 
           class="delete-button"
           onmouseover="this.style.backgroundColor='#ff6b6b'" 
           onmouseout="this.style.backgroundColor='#ff4444'"
           onclick="return confirm('Warning: This action will permanently delete all CSV files. Are you sure you want to proceed?')">
            <i class="icon">üóëÔ∏è</i>Delete All CSV Files
        </a>
    </div>
    
    <style>
        .dashboard-container {
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .dashboard-title {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .wifi-status {
            background-color: transparent;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            margin-bottom: 20px;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .menu-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .menu-button {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            background-color: rgba(76, 175, 80, 0.9);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .menu-button:hover {
            background-color: rgba(69, 160, 73, 0.9);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .icon {
            margin-right: 10px;
            font-style: normal;
        }
        
        .delete-button {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 20px;
            padding: 12px 20px;
            background-color: rgba(255, 68, 68, 0.9);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .delete-button:hover {
            box-shadow: 0 4px 8px rgba(255,0,0,0.2);
        }
        
        @media (max-width: 480px) {
            .dashboard-container {
                padding: 10px;
            }
            
            .menu-button, .delete-button {
                padding: 10px 15px;
            }
        }
    </style>
      </body>
    </html>
  )rawliteral";

  server.send(200, "text/html", htmlPage);
}

// Serve the Wi-Fi settings page
void handleWifiSettings() {
  if (!authenticateUser()) {
    return;
  }

  String htmlPage = R"rawliteral(
    <!DOCTYPE html>
    <html>
      <body>
        <h2>Change Wi-Fi Settings</h2>
        <form action="/saveWifi" method="POST">
          <label for="ssid">SSID:</label><br>
          <input type="text" id="ssid" name="ssid" value=")rawliteral" + ssid + R"rawliteral("><br><br>
          <label for="password">Password:</label><br>
          <input type="password" id="password" name="password" value=")rawliteral" + password + R"rawliteral("><br><br>
          <input type="submit" value="Save Wi-Fi Settings">
        </form>
      </body>
    </html>
  )rawliteral";

  server.send(200, "text/html", htmlPage);
}

// Save new Wi-Fi credentials
void handleSaveWifi() {
  if (!server.hasArg("ssid") || !server.hasArg("password")) {
    server.send(400, "text/html", "Missing SSID or password");
    return;
  }

  ssid = server.arg("ssid");
  password = server.arg("password");

  preferences.begin("WiFi", false);
  preferences.putString("ssid", ssid);
  preferences.putString("password", password);
  preferences.end();

  // Connect to new Wi-Fi
  if (connectToWiFi(ssid.c_str(), password.c_str())) {
    server.send(200, "text/html", "<h2>Wi-Fi settings saved. Rebooting...</h2>");
    delay(2000);
    ESP.restart();
  } else {
    server.send(500, "text/html", "<h2>Failed to connect to Wi-Fi.</h2>");
  }
}

// Teacher enrollment page
void handleEnrollTeacher() {
  if (!authenticateUser()) {
    return;
  }

  String htmlPage = R"rawliteral(
    <!DOCTYPE html>
    <html>
      <body>
        <h2>Teacher Enrollment</h2>
        <form action="/enrollTeacherSubmit" method="POST">
          <label for="teacherId">Teacher ID (SL):</label><br>
          <input type="text" id="teacherId" name="teacherId"><br><br>
          <label for="teacherName">Teacher Name:</label><br>
          <input type="text" id="teacherName" name="teacherName"><br><br>
          <label for="coursecode">Course Code:</label><br>
          <input type="text" id="coursecode" name="coursecode"><br><br>
          <input type="submit" value="Enroll Teacher">
        </form>
      </body>
    </html>
  )rawliteral";

  server.send(200, "text/html", htmlPage);
}

// Enroll a teacher and take attendance
void enrollTeacher(int teacherId, const String& teacherName, const String& coursecode) {
    if (!initializeFingerprint()) {
        lcd.clear();
        lcd.setCursor(0, 0);
        lcd.print("Sensor Error!");
        lcd.setCursor(0, 1);
        lcd.print("Try Again Later");
        delay(3000);
        return;
    }
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("Enrol Teacher ID:");
  
  delay(2000);
  Serial.print("Starting enrollment for Teacher ID: ");
  Serial.println(teacherId);

  // Directly initialize the fingerprint sensor here
  mySerial.begin(57600);
  delay(1000);
  finger.begin(57600);

  int status;
  while ((status = finger.getImage()) != FINGERPRINT_OK) {
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("Place your finger");
    lcd.setCursor(0, 1);
    lcd.print("on the sensor.");
    delay(2000);
    Serial.println("Place your finger on the sensor.");
    delay(1000);
  }

  Serial.println("Fingerprint image taken.");
  if (finger.image2Tz(1) != FINGERPRINT_OK) {
    Serial.println("Failed to create template.");
    return;
  }
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("Place same finger");
  lcd.setCursor(0, 1);
  lcd.print("on the sensor.");
  delay(2000);
  Serial.println("Place the same finger again.");
  while ((status = finger.getImage()) != FINGERPRINT_OK) {
    Serial.println("Waiting for second fingerprint image.");
    delay(1000);
  }

  if (finger.image2Tz(2) != FINGERPRINT_OK) {
    Serial.println("Failed to create second template.");
    return;
  }

  if (finger.createModel() != FINGERPRINT_OK) {
    Serial.println("Failed to create fingerprint model.");
    return;
  }

  if (finger.storeModel(teacherId) != FINGERPRINT_OK) {
    Serial.println("Failed to store fingerprint model.");
    return;
  }
   lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("finger print");
  lcd.setCursor(0, 1);
  lcd.print("enroll sucesses");
  delay(2000);
  Serial.println("Fingerprint enrollment successful.");
  saveTeacherData(teacherId, teacherName, coursecode);
}

// Save teacher data to the CSV file
void saveTeacherData(int teacherId, const String& teacherName, const String& coursecode) {
  // Save to local storage first
  File file = SPIFFS.open(teacherDataFile, FILE_APPEND);
  if (!file) {
    Serial.println("Failed to open teacher data file for appending.");
    return;
  }

  String dataLine = String(teacherId) + "," + teacherName + "," + coursecode + "\n";
  file.print(dataLine);
  file.close();

  // Create JSON for Supabase
  StaticJsonDocument<200> doc;
  doc["teacher_id"] = teacherId;
  doc["name"] = teacherName;
  doc["course_code"] = coursecode;
  
  String jsonString;
  serializeJson(doc, jsonString);
  
  bool cloudSaved = sendToSupabase("teachers", jsonString);

  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("Teacher saved:");
  lcd.setCursor(0, 1);
  lcd.print(teacherName);
  delay(2000);

  if (cloudSaved) {
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("Cloud sync done");
    delay(1000);
  }

  Serial.println("Teacher data saved: " + dataLine);
}

// Serve the teacher data file for download
void handleDownloadTeachers() {
  if (!authenticateUser()) {
    return;
  }

  File file = SPIFFS.open(teacherDataFile, FILE_READ);
  if (!file) {
    server.send(500, "text/html", "<h2>Failed to open teacher data file.</h2>");
    return;
  }

  server.streamFile(file, "text/csv");
  file.close();
}

// Student enrollment page
void handleEnrollStudent() {
  if (!authenticateUser()) {
    return;
  }

  String htmlPage = R"rawliteral(
    <!DOCTYPE html>
    <html>
      <body>
        <h2>Student Enrollment</h2>
        <form action="/enrollStudentSubmit" method="POST">
          <label for="studentId">Student ID (SL):</label><br>
          <input type="text" id="studentId" name="studentId"><br><br>
          <label for="studentName">Student Name:</label><br>
          <input type="text" id="studentName" name="studentName"><br><br>
          <label for="stdroll">Student Roll Number:</label><br>
          <input type="text" id="stdroll" name="stdroll"><br><br>
          <input type="submit" value="Enroll Student">
        </form>
      </body>
    </html>
  )rawliteral";

  server.send(200, "text/html", htmlPage);
}

// Enroll a student and take attendance
void enrollStudent(int studentId, const String& studentName, const String& stdroll) {
   if (!initializeFingerprint()) {
        lcd.clear();
        lcd.setCursor(0, 0);
        lcd.print("Sensor Error!");
        lcd.setCursor(0, 1);
        lcd.print("Try Again Later");
        delay(3000);
        return;
    }
  Serial.print("Starting enrollment for Student ID: ");
  Serial.println(studentId);
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("StR ENR st id");
  lcd.setCursor(0, 1);
  lcd.print(stdroll);
  delay(2000);

  // Directly initialize the fingerprint sensor here
  mySerial.begin(57600);
  delay(1000);
  finger.begin(57600);

  int status;
  while ((status = finger.getImage()) != FINGERPRINT_OK) {
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("place :");
    lcd.setCursor(0, 1);
    lcd.print("finger");
    Serial.println("Place your finger on the sensor.");
    delay(1000);
  }

  Serial.println("Fingerprint image taken.");
  if (finger.image2Tz(1) != FINGERPRINT_OK) {
    Serial.println("Failed to create template.");
    return;
  }
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("place same:");
  lcd.setCursor(0, 1);
  lcd.print("finger again");
  delay(2000);
  Serial.println("Place the same finger again.");
  while ((status = finger.getImage()) != FINGERPRINT_OK) {
    Serial.println("Waiting for second fingerprint image.");
    delay(1000);
  }

  if (finger.image2Tz(2) != FINGERPRINT_OK) {
    Serial.println("Failed to create second template.");
    return;
  }

  if (finger.createModel() != FINGERPRINT_OK) {
    Serial.println("Failed to create fingerprint model.");
    return;
  }

  if (finger.storeModel(studentId) != FINGERPRINT_OK) {
    Serial.println("Failed to store fingerprint model.");
    return;
  }
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("Finferprint Enroll");
  lcd.setCursor(0, 1);
  lcd.print("success");
  delay(2000);
  Serial.println("Fingerprint enrollment successful.");
  saveStudentData(studentId, studentName, stdroll);
}

// Save student data to the CSV file
void saveStudentData(int studentId, const String& studentName, const String& stdroll) {
 // Save locally
 File file = SPIFFS.open(studentDataFile, FILE_APPEND);
 if (!file) {
   Serial.println("Failed to open student data file for appending.");
   return;
 }

 String dataLine = String(studentId) + "," + studentName + "," + stdroll + "\n";
 file.print(dataLine);
 file.close();

 // Save to Supabase
 StaticJsonDocument<200> doc;
 doc["student_id"] = studentId;
 doc["name"] = studentName;
 doc["roll_number"] = stdroll;
 
 String jsonString;
 serializeJson(doc, jsonString);
 bool cloudSaved = sendToSupabase("students", jsonString);

 Serial.println("Student data saved: " + dataLine);
 lcd.clear();
 lcd.setCursor(0, 0);
 lcd.print("stnd saved:");
 lcd.setCursor(0, 1);
 lcd.print(stdroll);
 delay(2000);

 if (cloudSaved) {
   lcd.clear();
   lcd.setCursor(0, 0);
   lcd.print("Cloud sync done"); 
   delay(1000);
 }
}
void handleDownloadStudents() {
  if (!authenticateUser()) {
    return;
  }

  File file = SPIFFS.open(studentDataFile, FILE_READ);
  if (!file) {
    server.send(500, "text/html", "<h2>Failed to open student data file.</h2>");
    return;
  }

  server.streamFile(file, "text/csv");
  file.close();
}


// for attensence mode

void handleattendencemode() {
  if (!authenticateUser()) {
    return;
  }

  String htmlPage = R"rawliteral(
    <!DOCTYPE html>
    <html>
    <head>
        <meta http-equiv="refresh" content="0;url=/attendanceMode">
        <title>Starting Attendance Mode</title>
    </head>
    <body>
        <h2>Starting attendance mode...</h2>
        <script>
            window.location.href = '/attendanceMode';
        </script>
    </body>
    </html>
  )rawliteral";

  server.send(200, "text/html", htmlPage);
}


bool isTeacherFingerprintValid(int teacherId, const String& coursecode) {
    if (!SPIFFS.exists(teacherDataFile)) {
        Serial.println("Teacher data file does not exist!");
        return false;
    }
    File file = SPIFFS.open(teacherDataFile, "r"); // Open the teacher CSV file
    if (!file) {
        Serial.println("Failed to open teacher data file!");
        return false;
    }

    while (file.available()) {
        
        String line = file.readStringUntil('\n');
        line.trim();
        if (line.length() == 0) continue; // Skip empty lines

        // Parse CSV line
        int comma1 = line.indexOf(',');
        int comma2 = line.lastIndexOf(',');

        if (comma1 == -1 || comma2 == -1 || comma1 == comma2) continue;

        String idStr = line.substring(0, comma1);
        String courseCodeStr = line.substring(comma2 + 1);

        if (idStr.toInt() == teacherId && courseCodeStr.equalsIgnoreCase(coursecode)) {
            file.close();
            return true; // Valid teacher ID and course code found
        }
    }

    file.close();
    return false; // Teacher ID and course code do not match
}




int getFingerprintID() {
    uint8_t p = finger.getImage();
    if (p == FINGERPRINT_NOFINGER) {
        Serial.println("No finger detected. Waiting for input...");
        return -1;  // Return early if no finger is detected
    }

    if (p != FINGERPRINT_OK) {
        Serial.println("Error capturing fingerprint image.");
        return -1;  // Handle other capture errors
    }

    p = finger.image2Tz();
    if (p != FINGERPRINT_OK) {
        Serial.println("Error converting fingerprint image.");
        return -1;
    }

    p = finger.fingerFastSearch();
    if (p != FINGERPRINT_OK) {
        Serial.println("No matching fingerprint found.");
        return -1;
    }

    return finger.fingerID; // Return the ID of the matched fingerprint
}




void clearSensorBuffer() {
    while (finger.getImage() != FINGERPRINT_NOFINGER) {
        delay(100); // Wait until the sensor reports no finger
    }
}


bool verifyTeacherFingerprint(String coursecode) {
    int teacherId;
    clearSensorBuffer();  // Ensure the sensor buffer is clear before starting

    while (true) {
        teacherId = getFingerprintID();  // Fetch fingerprint ID
        if (teacherId == -1) {
            Serial.println("No fingerprint detected. Please place your finger.");
            lcd.clear();
            lcd.setCursor(0, 0);
            lcd.print("No finger found");
            lcd.setCursor(0, 1);
            lcd.print("Try again...");
            delay(2000);
            continue;  // Keep waiting until a fingerprint is detected
        }

        // Check if the fingerprint matches the teacher ID and course code
        if (isTeacherFingerprintValid(teacherId, coursecode)) {
            Serial.println("Teacher fingerprint verified successfully.");
            lcd.clear();
            lcd.setCursor(0, 0);
            lcd.print("Verification");
            lcd.setCursor(0, 1);
            lcd.print("Success!");
            delay(2000);
            return true;  // Verification successful
        } else {
            Serial.println("Fingerprint detected but verification failed.");
            lcd.clear();
            lcd.setCursor(0, 0);
            lcd.print("Verification");
            lcd.setCursor(0, 1);
            lcd.print("Failed!");
            delay(2000);
            return false;  // Verification failed
        }
    }
}


int processStudentAttendance(const String &coursecode) {
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("Scan Student Finger");
    Serial.println("Awaiting student fingerprint...");

    while (true) {
        int result = finger.getImage();
        if (result == FINGERPRINT_NOFINGER) {
            delay(100);
            continue;
        }

        if (result != FINGERPRINT_OK) {
            Serial.println("Error capturing fingerprint image.");
            lcd.clear();
            lcd.setCursor(0, 0);
            lcd.print("Error Reading");
            lcd.setCursor(0, 1);
            lcd.print("Try Again");
            delay(2000);
            return -2;
        }

        result = finger.image2Tz();
        if (result != FINGERPRINT_OK) {
            Serial.println("Error converting fingerprint image.");
            return -2;
        }

        result = finger.fingerFastSearch();
        if (result != FINGERPRINT_OK) {
            Serial.println("Fingerprint not recognized!");
            lcd.clear();
            lcd.setCursor(0, 0);
            lcd.print("Invalid Finger");
            delay(2000);
            return -1;
        }

        int studentId = finger.fingerID;
        
        // First check if student exists in database
        String studentName = fetchStudentName(studentId);
        if (studentName.isEmpty() || studentName == "Unknown Student") {
            Serial.println("Fingerprint matched but student not in database!");
            lcd.clear();
            lcd.setCursor(0, 0);
            lcd.print("Unknown Student");
            lcd.setCursor(0, 1);
            lcd.print("Not Recorded");
            delay(2000);
            return -4; // New error code for unknown student
        }

        if (studentId < 0 || studentId >= MAX_STUDENTS) {
            Serial.println("Invalid student ID.");
            return -1;
        }

        if (attendedStudents[studentId]) {
            Serial.println("Duplicate attendance detected.");
            lcd.clear();
            lcd.setCursor(0, 0);
            lcd.print("Already Marked");
            lcd.setCursor(0, 1);
            lcd.print("Attendance");
            delay(2000);
            return -3;
        }

        attendedStudents[studentId] = true;
        Serial.println("Fingerprint recognized. ID: " + String(studentId));
        return studentId;
    }
}





String fetchStudentName(int studentId) {
  File studentFile = SPIFFS.open("/students.csv", FILE_READ);
  if (!studentFile) {
    Serial.println("Failed to open student file!");
    return "";
  }

  while (studentFile.available()) {
    String line = studentFile.readStringUntil('\n');
    int idIndex = line.indexOf(',');
    int nameIndex = line.lastIndexOf(',');

    String id = line.substring(0, idIndex);
    String name = line.substring(idIndex + 1, nameIndex);

    if (id.toInt() == studentId) {
      studentFile.close();
      return name;
    }
  }

  studentFile.close();
  return "Unknown Student";
}


void attendanceMode() {
    if (!initializeFingerprint()) {
        lcd.clear();
        lcd.setCursor(0, 0);
        lcd.print("Sensor Error!");
        lcd.setCursor(0, 1);
        lcd.print("Try Again Later");
        delay(3000);
        return;
    }
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("Attendance Mode");
    lcd.setCursor(0, 1);
    lcd.print("Starting...");
    Serial.println("Attendance mode started.");

    String coursecode = "";

    // Reset the attendance tracking array
    memset(attendedStudents, false, sizeof(attendedStudents));

    // Prompt for course code
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("Enter Course Code:");
    Serial.println("Awaiting course code...");

    while (true) {
        char key = keypad.getKey();
        if (key) {
            if (key == '#') {  // End of input
                Serial.println("Course code entered: " + coursecode);
                break;
            } else {
                coursecode += key;
                lcd.print(key);
                Serial.print(key);
            }
        }
    }

    // Verify teacher fingerprint
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("Verify Teacher...");
    Serial.println("Place teacher's finger on the sensor.");

    if (!verifyTeacherFingerprint(coursecode)) {
        lcd.clear();
        lcd.setCursor(0, 0);
        lcd.print("Verification Failed");
        Serial.println("Teacher fingerprint verification failed.");
        delay(3000);
        return;
    }

    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("Attendance Start");
    Serial.println("Attendance started for course: " + coursecode);

    while (true) {
        lcd.clear();
        lcd.setCursor(0, 0);
        lcd.print("Awaiting Student");

        int studentId = processStudentAttendance(coursecode);
           
        if (studentId > 0) {
            String studentName = fetchStudentName(studentId);
            // Double check to ensure student exists in database
            if (!studentName.isEmpty() && studentName != "Unknown Student") {
                saveAttendance(coursecode, studentName, studentId);
                lcd.clear();
                lcd.setCursor(0, 0);
                lcd.print("Marked for:");
                lcd.setCursor(0, 1);
                lcd.print(studentName);
                Serial.println("Attendance recorded for: " + studentName);
                delay(2000);
            }
        } else if (studentId == -1) {
            Serial.println("Invalid fingerprint. Attendance not recorded.");
        } else if (studentId == -3) {
            Serial.println("Duplicate attendance. Skipping.");
        } else if (studentId == -4) {
            Serial.println("Unknown student. Attendance not recorded.");
        }

        // Allow teacher to end attendance session
        if (verifyTeacherFingerprint(coursecode)) {
            lcd.clear();
            lcd.setCursor(0, 0);
            lcd.print("Attendance Ended");
            Serial.println("Attendance session ended.");
            delay(3000);
            break;
        }
    }
}

void saveAttendance(String coursecode, String studentName, int studentId) {
 time_t now = time(nullptr);
 struct tm *localTime = localtime(&now);
 char timestamp[32];
 strftime(timestamp, sizeof(timestamp), "%Y-%m-%d %H:%M:%S", localTime);

 // Save locally
 File attendanceFile = SPIFFS.open("/attendance.csv", FILE_APPEND);
 if (!attendanceFile) {
   Serial.println("Failed to open attendance file!");
   return;
 }

 String record = coursecode + "," + studentName + "," + String(studentId) + "," + String(timestamp) + "\n";
 attendanceFile.print(record);
 attendanceFile.close();
 Serial.println("Attendance saved: " + record);

 // Save to Supabase
 StaticJsonDocument<300> doc;
 doc["course_code"] = coursecode;
 doc["student_name"] = studentName;
 doc["student_id"] = studentId;
 doc["timestamp"] = timestamp;
 
 String jsonString;
 serializeJson(doc, jsonString);
 bool cloudSaved = sendToSupabase("attendance", jsonString);

 lcd.clear();
 lcd.setCursor(0, 0);
 lcd.print("Marked for:");
 lcd.setCursor(0, 1);
 lcd.print(studentName);
 delay(2000);

 if (cloudSaved) {
   lcd.clear();
   lcd.setCursor(0, 0);
   lcd.print("Cloud sync done");
   delay(1000);
 }
}



void handleDownloadAttendance() {
    // Ensure user is authenticated
    if (!authenticateUser()) {
        return;
    }

    // Check if the attendance file exists
    if (!SPIFFS.exists("/attendance.csv")) {
        server.send(404, "text/plain", "Attendance file not found.");
        Serial.println("Attendance file not found.");
        return;
    }

    // Open the attendance file for reading
    File attendanceFile = SPIFFS.open("/attendance.csv", FILE_READ);
    if (!attendanceFile) {
        server.send(500, "text/plain", "Failed to open attendance file.");
        Serial.println("Failed to open attendance file.");
        return;
    }

    // Serve the file
    server.streamFile(attendanceFile, "text/csv");
    attendanceFile.close();
    Serial.println("Attendance file served successfully.");
}



// Function to delete all the CSV files
void deleteAllCSVFiles() {
  // Check and delete teachers.csv
  if (SPIFFS.exists(teacherDataFile)) {
    if (SPIFFS.remove(teacherDataFile)) {
      Serial.println("teachers.csv file deleted successfully.");
    } else {
      Serial.println("Failed to delete teachers.csv file.");
    }
  } else {
    Serial.println("teachers.csv file does not exist.");
  }

  // Check and delete students.csv
  if (SPIFFS.exists(studentDataFile)) {
    if (SPIFFS.remove(studentDataFile)) {
      Serial.println("students.csv file deleted successfully.");
    } else {
      Serial.println("Failed to delete students.csv file.");
    }
  } else {
    Serial.println("students.csv file does not exist.");
  }

  // Check and delete attendance.csv
  if (SPIFFS.exists("/attendance.csv")) {
    if (SPIFFS.remove("/attendance.csv")) {
      Serial.println("attendance.csv file deleted successfully.");
    } else {
      Serial.println("Failed to delete attendance.csv file.");
    }
  } else {
    Serial.println("attendance.csv file does not exist.");
  }
}

// Call this function through an HTTP endpoint or directly in the code
void handleDeleteAllCSVFiles() {
  if (!authenticateUser()) {
    return;
  }
  
  deleteAllCSVFiles();
  server.send(200, "text/html", "<h2>All CSV files deleted successfully!</h2>");
}
// Define a structure to store temporary attendance records
struct AttendanceRecord {
    int studentId;
    String studentName;
    bool isValid;
};

// Array to store temporary attendance records
const int MAX_TEMP_RECORDS = 100;
AttendanceRecord tempAttendance[MAX_TEMP_RECORDS];
int tempAttendanceCount = 0;

void startAttendanceProcess() {
    if (!initializeFingerprint()) {
        lcd.clear();
        lcd.setCursor(0, 0);
        lcd.print("Sensor Error!");
        lcd.setCursor(0, 1);
        lcd.print("Try Again Later");
        delay(3000);
        isAttendanceMode = false;
        return;
    }
    
    // Reset temporary attendance storage
    tempAttendanceCount = 0;
    memset(attendedStudents, false, sizeof(attendedStudents));
    
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("Attendance Mode");
    lcd.setCursor(0, 1);
    lcd.print("Starting...");
    Serial.println("Attendance mode started.");

    String coursecode = "";

    // Prompt for course code
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("Enter Course Code:");
    Serial.println("Awaiting course code...");

    while (isAttendanceMode) {
        char key = keypad.getKey();
        if (key) {
            if (key == 'B') {  // Cancel attendance mode
                isAttendanceMode = false;
                cancelAttendanceProcess();
                return;
            }
            else if (key == '*') {  // Backspace functionality
                if (coursecode.length() > 0) {
                    coursecode = coursecode.substring(0, coursecode.length() - 1);
                    lcd.clear();
                    lcd.setCursor(0, 0);
                    lcd.print("Enter Course Code:");
                    lcd.setCursor(0, 1);
                    lcd.print(coursecode);
                }
            }
            else if (key == '#') {  // End of input
                if (coursecode.length() > 0) {
                    Serial.println("Course code entered: " + coursecode);
                    break;
                }
            }
            else if (key != 'A') {  // Normal number input
                coursecode += key;
                lcd.setCursor(0, 1);
                lcd.print(coursecode);
                Serial.print(key);
            }
        }
    }

    if (!isAttendanceMode) return;

    // Verify initial teacher fingerprint
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("Verify Teacher...");
    Serial.println("Place teacher's finger on the sensor.");

    if (!verifyTeacherFingerprint(coursecode)) {
        lcd.clear();
        lcd.setCursor(0, 0);
        lcd.print("Verification Failed");
        Serial.println("Teacher fingerprint verification failed.");
        delay(3000);
        isAttendanceMode = false;
        return;
    }

    // Main attendance collection loop
    while (isAttendanceMode) {
        lcd.clear();
        lcd.setCursor(0, 0);
        lcd.print("Place Finger");
        lcd.setCursor(0, 1);
        lcd.print("Or End Session");

        int studentId = getFingerprintID();
        
        // Check if it's the teacher's fingerprint
        if (studentId > 0 && isTeacherFingerprintValid(studentId, coursecode)) {
            // Teacher verified - end session and save attendance
            lcd.clear();
            lcd.setCursor(0, 0);
            lcd.print("Saving Records...");
            
            // Save all collected attendance records
            for (int i = 0; i < tempAttendanceCount; i++) {
                if (tempAttendance[i].isValid) {
                    saveAttendance(coursecode, tempAttendance[i].studentName, tempAttendance[i].studentId);
                }
            }
            
            lcd.clear();
            lcd.setCursor(0, 0);
            lcd.print("Session Ended");
            lcd.setCursor(0, 1);
            lcd.print("Records: ");
            lcd.print(tempAttendanceCount);
            delay(3000);
            isAttendanceMode = false;
            break;
        }
        
        // Process student fingerprint
        if (studentId > 0) {
            String studentName = fetchStudentName(studentId);
            if (!studentName.isEmpty() && studentName != "Unknown Student" && !attendedStudents[studentId]) {
                // Valid student found and not already marked
                attendedStudents[studentId] = true;
                
                // Store in temporary array
                if (tempAttendanceCount < MAX_TEMP_RECORDS) {
                    tempAttendance[tempAttendanceCount].studentId = studentId;
                    tempAttendance[tempAttendanceCount].studentName = studentName;
                    tempAttendance[tempAttendanceCount].isValid = true;
                    tempAttendanceCount++;
                    
                    lcd.clear();
                    lcd.setCursor(0, 0);
                    lcd.print("Recorded:");
                    lcd.setCursor(0, 1);
                    lcd.print(studentName);
                    delay(1500);
                }
            }else if (studentName.isEmpty() || studentName == "Unknown Student") {
                lcd.clear();
                lcd.setCursor(0, 0);
                lcd.print("Unknown Student");
                lcd.setCursor(0, 1);
                lcd.print("Not Recorded");
                delay(2000);

        }}

        // Check for cancel key
        char key = keypad.getKey();
        if (key == 'B') {
            cancelAttendanceProcess();
            break;
        }
        
        delay(100);  // Small delay to prevent too rapid scanning
    }
}

void cancelAttendanceProcess() {
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("Session Cancelled");
    lcd.setCursor(0, 1);
    lcd.print("No Records Saved");
    Serial.println("Attendance mode cancelled.");
    delay(2000);
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("Ready");
    isAttendanceMode = false;
    tempAttendanceCount = 0;  // Reset temporary storage
}













void setup() {
  
  Serial.begin(115200);
  mySerial.begin(57600); // Start serial for the sensor
  finger.begin(57600);
   Wire.begin(21, 22);
    lcd.begin(16, 2);
    lcd.backlight();
    lcd.clear();
    lcd.print("Starting up...");
    
    // Initialize fingerprint sensor
    if (!initializeFingerprint()) {
        Serial.println("Failed to initialize fingerprint sensor!");
        lcd.clear();
        lcd.setCursor(0, 0);
        lcd.print("Sensor Failed!");
        delay(2000);
    }  
  configTime(0, 0, "pool.ntp.org"); // Initialize the Adafruit Fingerprint library

  if (finger.verifyPassword()) {
        Serial.println("Fingerprint sensor detected!");
  } else {
        Serial.println("Fingerprint sensor not detected or communication error.");
        while (1) delay(1000); // Halt execution if the sensor is not detected
  }
  preferences.begin("WiFi", false);

  SPIFFS.begin();
  if (!SPIFFS.begin(true)) { // Format SPIFFS if mounting fails
        Serial.println("Failed to mount SPIFFS!");
        return;
    }
    Serial.println("SPIFFS mounted successfully.");

  
  

  ssid = preferences.getString("ssid", "");
  password = preferences.getString("password", "");
  lcd.setCursor(0, 0);    // Set cursor to first row, first column
  lcd.print("Connecting...");
  

  if (ssid == "" || password == "") {
    startAccessPoint();
  } else {
    // Try connecting to saved Wi-Fi network
    if (!connectToWiFi(ssid.c_str(), password.c_str())) {
      startAccessPoint();
    }
  }
  server.on("/editTeacher", HTTP_GET, handleEditTeacher);
  server.on("/updateTeacher", HTTP_GET, handleUpdateTeacher);
  server.on("/deleteTeacher", HTTP_GET, handleDeleteTeacher);
  server.on("/editStudent", HTTP_GET, handleEditStudent);
  server.on("/updateStudent", HTTP_GET, handleUpdateStudent);
  server.on("/deleteStudent", HTTP_GET, handleDeleteStudent);
  server.on("/", HTTP_GET, handleRoot);
  server.on("/wifi", HTTP_GET, handleWifiSettings);
  server.on("/saveWifi", HTTP_POST, handleSaveWifi);
  server.on("/enrollTeacher", HTTP_GET, handleEnrollTeacher);
  server.on("/enrollTeacherSubmit", HTTP_POST, []() {
    String teacherId = server.arg("teacherId");
    String teacherName = server.arg("teacherName");
    String coursecode = server.arg("coursecode");

    enrollTeacher(teacherId.toInt(), teacherName, coursecode);
    server.send(200, "text/html", "<h2>Teacher enrolled successfully!</h2>");
  });
  server.on("/downloadTeachers", HTTP_GET, handleDownloadTeachers);
  server.on("/enrollStudent", HTTP_GET, handleEnrollStudent);
  server.on("/enrollStudentSubmit", HTTP_POST, []() {
    String studentId = server.arg("studentId");
    String studentName = server.arg("studentName");
    String stdroll = server.arg("stdroll");

    enrollStudent(studentId.toInt(), studentName, stdroll);
    server.send(200, "text/html", "<h2>Student enrolled successfully!</h2>");
  });
  server.on("/downloadStudents", HTTP_GET, handleDownloadStudents);
  server.on("/attendencemode", HTTP_GET, handleattendencemode);
  server.on("/attendanceMode", HTTP_GET, attendanceMode);
  
  server.on("/deleteAllFiles", HTTP_GET, handleDeleteAllCSVFiles);
  server.on("/downloadAttendance", HTTP_GET, handleDownloadAttendance);
  server.on("/deleteAllFiles", HTTP_GET, handleDeleteAllCSVFiles);
 
  
  
  

  server.begin();
}


 // To hold the entered characters


  
 

void loop() {

  server.handleClient();
  char key = keypad.getKey();
   if (key) {
    switch (key) {
      case 'A':
        if (!isAttendanceMode) {
          isAttendanceMode = true;
          startAttendanceProcess();
        }
        break;
      case 'B':
        if (isAttendanceMode) {
          isAttendanceMode = false;
          cancelAttendanceProcess();
        }
        break;
    }
  }
 

}
